#!/bin/bash
########################################################################################################################
# Backup Config ########################################################################################################
########################################################################################################################
NAME="{{NAME}}"
SCRIPTPATH="{{SCRIPTPATH}}"
BACKUP_DIR="${SCRIPTPATH}/backups"
WWW_DIR="${SCRIPTPATH}/../"


########################################################################################################################
# Project Database #####################################################################################################
########################################################################################################################
DB_USER="{{DB_USER}}"
DB_PASS="{{DB_PASS}}"
DB_NAME="{{DB_NAME}}"
DB_HOST="{{DB_HOST}}"


########################################################################################################################
# Excludes #############################################################################################################
########################################################################################################################
WWW_EXCLUDE1="resources/assets/node_modules"
WWW_EXCLUDE2="resources/assets/.sass-cache"
WWW_EXCLUDE3="public/wp-content/cache"
WWW_EXCLUDE4="backup/backups"


########################################################################################################################
# General Constants ####################################################################################################
########################################################################################################################
NOW=$(date +"%Y%m%d-%H%M")
FILE="$NOW-$NAME.tar"


########################################################################################################################
# Project Databases ####################################################################################################
########################################################################################################################
# Backup database filename
DB_FILE="$NOW-$NAME.sql"

# Tar transforms for better archive structure
WWW_TRANSFORM="s,^${WWW_DIR:1},www,"
DB_TRANSFORM="s,^${BACKUP_DIR:1},database,"


########################################################################################################################
# Create Backup folder if not exists ###################################################################################
########################################################################################################################
[ -d $BACKUP_DIR ] || mkdir -p $BACKUP_DIR


########################################################################################################################
# Project with DB ######################################################################################################
########################################################################################################################
# Create the archive and the MySQL dump
tar -cvf $BACKUP_DIR/$FILE $WWW_DIR --exclude=$WWW_EXCLUDE1 --exclude=$WWW_EXCLUDE2 --exclude=$WWW_EXCLUDE3 --exclude=$WWW_EXCLUDE4 --exclude-vcs --transform $WWW_TRANSFORM
mysqldump -h $DB_HOST -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/$DB_FILE

# Append the dump to the archive, remove the dump and compress the whole archive.
tar --append --file=$BACKUP_DIR/$FILE --transform $DB_TRANSFORM $BACKUP_DIR/$DB_FILE
rm $BACKUP_DIR/$DB_FILE
gzip -9 $BACKUP_DIR/$FILE